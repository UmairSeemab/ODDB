<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Drug-based Ocular Disease Statistics (by Phase)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="shortcut icon" href="images/fevicon.ico.png" type="image/x-icon" />
  <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Site CSS -->
  <link rel="stylesheet" href="style.css">
  <!-- ALL VERSION CSS -->
  <link rel="stylesheet" href="css/versions.css">
  <!-- Responsive CSS -->
  <link rel="stylesheet" href="css/responsive.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/custom.css">
  <!-- Modernizer for Portfolio -->
  <script src="js/modernizer.js"></script>
  <!-- [if lt IE 9] -->


  <style>
    body {
      font-family: Arial, sans-serif;
      /*padding: 20px;*/
    }

    h2 {
      margin-bottom: 8px;
    }

    .sub {
      color: #555;
      margin-top: 0;
    }

    #chart {
      width: 900px;
      height: 600px;
      max-width: 100%;
    }

    .controls {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      border-radius: 6px;
    }

    .button:hover {
      background-color: #0056b3;
    }

    select {
      font-size: 14px;
    }

    #columns {
      min-width: 260px;
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #666;
      padding: 8px 12px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .hint {
      color: #666;
      font-style: italic;
    }

    .spacer {
      flex: 1 1 auto;
    }
  </style>
  <style>
    table {
      border-collapse: collapse;
      width: 80%;
      margin-top: 0px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    td {
      color: #999;
    }

    th {
      background: #fff;
      color: #157fda
    }
  </style>
</head>

<body>
  <header>
    <div class="header-top wow fadeIn ">
      <div class="container">
        <div class="row align-items-center">
          <!-- Logo -->
          <div class="col-md-4">
            <a class="navbar-brand" href="index.html">
              <img src="images/logoo.png" alt="image" style="width:100px;margin-top:-10px">
            </a>
          </div>

          <!-- Navigation with custom class for padding adjustments -->
          <div class="col-md-8 text-right custom-nav">
            <div id="navbar" class="navbar-collapse collapse">
              <ul class="nav navbar-nav d-flex justify-content-end">
                <li><a class="active nav-li" href="index.html">Home</a></li>
                <li><a class="nav-li" data-scroll href="about_us.html">About us</a></li>
                <li><a class="nav-li" data-scroll href="#Tutorial">Tutorial</a></li>
                <!-- Dropdown Start -->
                <li class="dropdown">
                  <a class="nav-li dropdown-toggle">Analysis</a>
                  <ul class="dropdown-menu">
                    <li><a href="Drug-based-stat.html">Drug based analysis</a></li>
                    <li><a href="Gene-based-stat.html">Gene based analysis</a></li>
                    <li><a href="MOI-stat.html">Inheritance based analysis</a></li>
                    <li><a href="Variant-based-stat.html">Variant based analysis</a></li>
                  </ul>
                </li>
                <!-- Dropdown End -->
                <li class="dropdown">
                  <a class="nav-li dropdown-toggle">Statistics</a>
                  <ul class="dropdown-menu">
                    <li><a href="Drug.html">Drug based statistics</a></li>
                    <li><a href="Gene.html">Gene based statistics</a></li>
                    <li><a href="Inheritance.html">Inheritance based statistics</a></li>
                    <li><a href="Variant.html">Variant based statistics</a></li>
                  </ul>
                </li>
                <!-- Dropdown End -->
                <li><a class="nav-li" data-scroll href="#Download">Download</a></li>
                <li><a class="nav-li" data-scroll href="#getintouch">Contact Us</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>



  <h2 style="margin-top: 120px;padding: 20px;">Distribution by Clinical Phase</h2>
  <p class="sub" style="padding: 20px;">Data source: <code>Eye_Disease_Drugs.xlsx</code>. Click a donut slice to view
    records for that Phase.
  </p>

  <div id="chart" style="padding: 20px;"></div>

  <div class="controls" style="padding: 20px;">
    <label for="countBy"><strong>Count uniques by:</strong></label>
    <select id="countBy">
      <!-- options are injected dynamically depending on available columns -->
    </select>

    <span class="spacer"></span>

    <label for="columns"><strong>Select columns to display:</strong></label>
    <select id="columns" multiple size="6"></select>

    <button class="button" id="update-table-btn">Update Table</button>
    <button class="button" id="download-csv-btn">Download Table as CSV</button>
    <button class="button" id="download-svg-btn">Download Chart as SVG</button>
  </div>

  <div id="table-hint" class="hint" style="padding: 20px;"><i>Select a Phase slice and choose columns to populate the
      table.</i></div>
  <div id="disease-table" style="padding: 20px;"></div>

  <footer id="footer" class="footer-area wow fadeIn" style="width: 100%">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <div class="logo padding">
            <a href=""><img src="images/logo1.png" alt=""></a>
            <p>A database for Ocular Diseases.</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="footer-info padding">
            <h3>CONTACT US</h3>
            <p><i class="fa fa-map-marker" aria-hidden="true"></i> UEF, Kuopio, Finland</p>
            <p><i class="fa fa-paper-plane" aria-hidden="true"></i> u.seemab@gmail.com</p>
            <p><i class="fa fa-phone" aria-hidden="true"></i> (+358) 123 456</p>
          </div>
        </div>
        <div class="col-md-4">
          <div id="statsContainer">
            <h1 style="text-align:left;font-weight:600;">
              Visitors count: <span id="visitorCount">0</span>
            </h1>

            <div style="max-height:128px; overflow-y:auto; border:1px solid #ccc;">
              <table border="1" cellspacing="0" cellpadding="8"
                style="width:100%; text-align:center; border-collapse:collapse;">
                <tbody id="statsTable"></tbody>
              </table>
            </div>
          </div>

          <script type="module">
            // Firebase imports from CDN
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
            import {
              getFirestore,
              collection,
              addDoc,
              getDocs,
              query,
              where,
              getDocs as getQueryDocs
            } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

            // ðŸ”¹ Your Firebase config
            const firebaseConfig = {
              apiKey: "AIzaSyA5VIAFJB1buNlmwNbbxyEpJmQdlVH5_84",
              authDomain: "daring-acumen-427809-i1.firebaseapp.com",
              projectId: "daring-acumen-427809-i1",
              storageBucket: "daring-acumen-427809-i1.firebasestorage.app",
              messagingSenderId: "390763490659",
              appId: "1:390763490659:web:6bb73c6ed513927cf03756",
              measurementId: "G-XYH6N9K123"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // ðŸ”¹ Save visitor to Firestore (with duplicate IP check per day)
            async function logVisitor() {
              try {
                const res = await fetch("https://get.geojs.io/v1/ip/geo.json");
                const data = await res.json();

                const ip = data.ip || "Unknown IP";

                // Smarter location fallback
                let location = "Unknown Location";
                if (data.city && data.country) {
                  location = `${data.city}, ${data.country}`;
                } else if (data.country) {
                  location = data.country;
                } else if (data.organization_name) {
                  location = data.organization_name;
                }

                const now = new Date();

                // Extract only the DATE part in US timezone
                const visitDate = now.toLocaleDateString("en-US", {
                  timeZone: "America/New_York"
                });

                // ðŸ”¹ Check if same IP visited today
                const visitorsRef = collection(db, "visitors");
                const q = query(visitorsRef, where("ip", "==", ip), where("date", "==", visitDate));
                const existing = await getQueryDocs(q);

                if (!existing.empty) {
                  console.log("IP already visited today, skipping add:", ip);
                  renderTable();
                  return;
                }

                // Save visitor log in Firestore
                await addDoc(visitorsRef, {
                  ip,
                  location,
                  date: visitDate, // store plain date
                  time: now.toLocaleString("en-US", {
                    timeZone: "America/New_York",
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: false
                  })
                });

                console.log("Visitor saved to Firebase!");
                renderTable();
              } catch (err) {
                console.error("Error logging visitor:", err);
              }
            }

            // ðŸ”¹ Fetch all visitors & render table (most recent first)
            async function renderTable() {
              const tbody = document.getElementById("statsTable");
              const visitorCount = document.getElementById("visitorCount");

              tbody.innerHTML = `<tr><td colspan="2">Loading...</td></tr>`;

              try {
                const snapshot = await getDocs(collection(db, "visitors"));
                // reverse() so most recent is first
                const logs = snapshot.docs.map(doc => doc.data()).reverse();

                visitorCount.textContent = logs.length;
                tbody.innerHTML = "";

                if (!logs.length) {
                  tbody.innerHTML = `<tr><td colspan="2">No visitors logged yet</td></tr>`;
                  return;
                }

                logs.slice(0, 15).forEach(log => {
                  const tr = document.createElement("tr");
                  tr.innerHTML = `<td>${log.location}</td><td>${log.time}</td>`;
                  tbody.appendChild(tr);
                });
              } catch (err) {
                tbody.innerHTML = `<tr><td colspan="2">Error loading logs: ${err.message}</td></tr>`;
              }
            }

            // Run on page load
            document.addEventListener("DOMContentLoaded", logVisitor);
          </script>
        </div>
      </div>
  </footer>
  <div class="copyright-area wow fadeIn" style="width: 100%">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <div class="footer-text">
            <p>Â© LRL Group. All Rights Reserved.</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="social">
            <ul class="social-links">
              <li><a href=""><i class="fa fa-rss"></i></a></li>
              <li><a href=""><i class="fa fa-facebook"></i></a></li>
              <li><a href=""><i class="fa fa-twitter"></i></a></li>
              <li><a href=""><i class="fa fa-google-plus"></i></a></li>
              <li><a href=""><i class="fa fa-youtube"></i></a></li>
              <li><a href=""><i class="fa fa-pinterest"></i></a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- helpers ---------- */
    function findColumn(objKeys, candidates) {
      // return the first case-sensitive match; also try case-insensitive
      for (const c of candidates) { if (objKeys.includes(c)) return c; }
      const lower = objKeys.map(k => k.toLowerCase());
      for (const c of candidates) {
        const idx = lower.indexOf(c.toLowerCase());
        if (idx !== -1) return objKeys[idx];
      }
      return null;
    }

    function uniqueCount(rows, key) {
      const s = new Set();
      rows.forEach(r => { if (r[key] != null && r[key] !== '') s.add(String(r[key])); });
      return s.size;
    }

    /* ---------- state ---------- */
    let fullData = [];
    let phaseKey = null;
    let drugKey = null;
    let diseaseKey = null;
    let countByKey = null;      // what weâ€™re counting uniques of (drugKey preferred)
    let grouped = [];           // [{phase, count, records}]
    let selectedPhaseRecords = [];

    /* ---------- main ---------- */
    async function init() {
      // 1) load workbook
      const response = await fetch('data/Eye_Disease_Drugs.xlsx');
      const data = await response.arrayBuffer();
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      fullData = XLSX.utils.sheet_to_json(worksheet);

      if (!fullData.length) {
        alert('No rows found in Eye_Disease_Drugs.xlsx');
        return;
      }

      // 2) detect columns
      const keys = Object.keys(fullData[0]);
      phaseKey = findColumn(keys, ['Phase', 'Clinical.Phase', 'Trial.Phase']);
      drugKey = findColumn(keys, ['Drug', 'Drug.Name', 'API']);
      diseaseKey = findColumn(keys, ['Ocular.disease', 'Disease', 'Disease.name']);

      if (!phaseKey) {
        alert('Could not find a Phase column. Tried: Phase, Clinical.Phase, Trial.Phase.\nFound columns: ' + keys.join(', '));
        return;
      }

      // choose default counting key: prefer Drug; else Disease; else fallback to first non-empty key
      if (drugKey) countByKey = drugKey;
      else if (diseaseKey) countByKey = diseaseKey;
      else {
        // find any non-phase key with at least some values to count
        countByKey = keys.find(k => k !== phaseKey);
      }

      // 3) setup "count by" selector
      const countSel = document.getElementById('countBy');
      countSel.innerHTML = '';
      if (drugKey) {
        const opt = document.createElement('option');
        opt.value = drugKey; opt.textContent = `Drug (${drugKey})`;
        countSel.appendChild(opt);
      }
      if (diseaseKey) {
        const opt = document.createElement('option');
        opt.value = diseaseKey; opt.textContent = `Disease (${diseaseKey})`;
        countSel.appendChild(opt);
      }
      // if neither exists, just show the chosen fallback key
      if (!countSel.options.length && countByKey) {
        const opt = document.createElement('option');
        opt.value = countByKey; opt.textContent = `Unique values of: ${countByKey}`;
        countSel.appendChild(opt);
      }
      if (countByKey) countSel.value = countByKey;
      countSel.addEventListener('change', () => {
        countByKey = countSel.value;
        buildChart();  // rebuild donut counts when metric changes
      });

      // 4) populate columns multi-select
      const columnsSelect = document.getElementById('columns');
      columnsSelect.innerHTML = '';
      keys.forEach(col => {
        const option = document.createElement('option');
        option.value = col;
        option.textContent = col;
        columnsSelect.appendChild(option);
      });

      // 5) listeners
      document.getElementById('update-table-btn').addEventListener('click', updateTable);
      document.getElementById('download-csv-btn').addEventListener('click', downloadCSV);
      document.getElementById('download-svg-btn').addEventListener('click', downloadSVG);

      // 6) draw chart
      buildChart();
    }

    function buildChart() {
      // group rows by Phase
      const phaseMap = {};
      fullData.forEach(row => {
        const p = row[phaseKey] ?? 'Unknown';
        if (!phaseMap[p]) phaseMap[p] = [];
        phaseMap[p].push(row);
      });

      grouped = Object.entries(phaseMap).map(([phase, records]) => ({
        phase,
        count: countByKey ? uniqueCount(records, countByKey) : records.length,
        records
      }));

      // sort phases by count desc for a nicer order
      grouped.sort((a, b) => b.count - a.count);

      const values = grouped.map(d => d.count);
      const labels = grouped.map(d => `${d.phase} (${d.count})`);

      const trace = {
        type: 'pie',
        values: values,
        labels: labels,
        hole: 0.4,
        textinfo: 'percent',
        textposition: 'inside',
        hovertemplate: `%{label}<extra></extra>`
      };
      const layout = {
        title: `Distribution by ${phaseKey} â€” counting unique ${(countByKey || 'rows')}`,
        showlegend: true,
        margin: { t: 60, b: 40, l: 10, r: 10 }
      };

      Plotly.newPlot('chart', [trace], layout);

      document.getElementById('chart').on('plotly_click', function (data) {
        const idx = data.points[0].pointNumber;
        selectedPhaseRecords = grouped[idx].records;
        document.getElementById('table-hint').style.display = 'none';
        updateTable();
      });
    }

    function updateTable() {
      const tableDiv = document.getElementById('disease-table');
      const selectedCols = Array.from(document.getElementById('columns').selectedOptions).map(o => o.value);

      if (!selectedCols.length || !selectedPhaseRecords.length) {
        tableDiv.innerHTML = '<p class="hint"><i>Select a Phase slice and choose columns to display.</i></p>';
        return;
      }

      let html = '<table id="drugPhaseTable"><thead><tr>';
      selectedCols.forEach(col => { html += `<th>${col}</th>`; });
      html += '</tr></thead><tbody>';

      selectedPhaseRecords.forEach(row => {
        html += '<tr>';
        selectedCols.forEach(col => {
          const val = row[col] == null ? '' : String(row[col]);
          html += `<td>${val}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      tableDiv.innerHTML = html;
    }

    function downloadCSV() {
      const selectedCols = Array.from(document.getElementById('columns').selectedOptions).map(o => o.value);
      if (!selectedCols.length || !selectedPhaseRecords.length) return;

      let csv = selectedCols.join(',') + '\n';
      selectedPhaseRecords.forEach(row => {
        const line = selectedCols.map(col => {
          const v = row[col] == null ? '' : String(row[col]).replace(/"/g, '""');
          return `"${v}"`;
        }).join(',');
        csv += line + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'drug_phase_table.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadSVG() {
      Plotly.downloadImage('chart', {
        format: 'svg',
        filename: 'drug_phase_donut_chart',
        height: 600,
        width: 900
      });
    }

    // boot
    init();
  </script>

</body>

</html>